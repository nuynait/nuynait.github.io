<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS Location Service · Tianyun Shan</title><meta name="description" content="iOS Location Service - Tianyun Shan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/img.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.jerryshan.com/atom.xml" title="Tianyun Shan"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/img.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS Location Service</h1><div class="post-info">Nov 2, 2016</div><div class="post-content"><p>This post talks about the basic for ios location service. How to setup the <code>CLLocationManager</code> to get user&#39;s current location? For Xcode 8.1, Swift 3.0</p>
<span id="more"></span>

<h1 id="iOS-Location-Service"><a href="#iOS-Location-Service" class="headerlink" title="iOS Location Service"></a>iOS Location Service</h1><p>I created this notes when I am implementing the navigation app for Mapsted. In any case we should fetch as less as location data possible to avoid battery drain so avoid getting location data constantly if possible.</p>
<h1 id="Link-Framework-and-Service-Info-Plist"><a href="#Link-Framework-and-Service-Info-Plist" class="headerlink" title="Link Framework and Service Info Plist"></a>Link Framework and Service Info Plist</h1><p>First step is to link the necessary framework and editing the <code>info.plist</code> to indicate the location access of the app.</p>
<p><code>CoreLocation.framework</code> link the framework and import the header file <code>#import &lt;CoreLocation/CoreLocation.h&gt;</code>. I will do it in a bridge header since I am using the swift.</p>
<p>For plist, first is the new privacy request message required by iOS 10.0 <code>Privacy - Location Always Usage Description</code> or <code>Privacy - Location When In Use Usage Description</code> you can choose for what you need depending on how you want to use the location service. Then I need to editing the <code>Required device capabilities</code> array. Include <code>location-services</code> string if I want location service in general, and <code>gps</code> string if I want to use the gps hardware to provides accuracy.</p>
<h1 id="Getting-User’s-Location-Data"><a href="#Getting-User’s-Location-Data" class="headerlink" title="Getting User’s Location Data"></a>Getting User’s Location Data</h1><p>Depending how you want to use the location data, you should always think how frequent are you going to get the data information. Try to make it as less as possible. There are two service available that gives you the user&#39;s current location. <code>standard location service</code> and <code>significant-change location</code></p>
<blockquote>
<p>The standard location service is a configurable, general-purpose solution for getting location data and tracking location changes for the specified level of accuracy.  </p>
</blockquote>
<blockquote>
<p>The significant-change location service delivers updates only when there has been a significant change in the device’s location, such as 500 meters or more.  </p>
</blockquote>
<h1 id="Is-Location-Service-Available"><a href="#Is-Location-Service-Available" class="headerlink" title="Is Location Service Available?"></a>Is Location Service Available?</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This seems not correct??</span></span><br><span class="line"><span class="comment"> You can call ~CLLocationManager.locationServiceEnabled()~ if returns ~true~,</span></span><br><span class="line"><span class="comment"> it means user has enabled the location service. If it returns ~false~, which</span></span><br><span class="line"><span class="comment"> means user has deny the location access and you access to user&#x27;s location data</span></span><br><span class="line"><span class="comment"> anyway, it will report error to delegate. However when user first opens the</span></span><br><span class="line"><span class="comment"> app, that method returns ~false~ as well and for the first time access,</span></span><br><span class="line"><span class="comment"> instead of return an error, it will ask user if they want to enable the</span></span><br><span class="line"><span class="comment"> location access.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h2><p>Here is an update on <code>CLLocationManager.locationServiceEnabled()</code>. The above commented text are taken from the apple documentation, but when I use <code>CLLocationManager.locationServiceEnabled()</code>, it always returns true, not matter I enabled the location service or not. Here is some questions with the same problem. <a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/4034095/locationservicesenabled-always-return-yes">1</a></p>
<p>So now the question becomes how do I check if user has enabled the location service or not? This is what I use. <code>CLLocationManager.authorizationStatus() == CLAuthorizationStatus.denied</code>.</p>
<p>Also, we should always handle errors catches in <code>locationManager:didFailWithError</code></p>
<h2 id="How-to-request-for-permission"><a href="#How-to-request-for-permission" class="headerlink" title="How to request for permission?"></a>How to request for permission?</h2><p>First, remember to set the <code>info.plist</code> like <em>this</em>. Then request for permission depends on what you need. <code>self.locationManager.requestWhenInUseAuthorization</code>, <code>self.locationManager.requestAlwaysAuthorization</code>.</p>
<p>It seems that when we manually request permission for locations, the request only works for the first time. If user disabled the location service, we need to capture using <code>CLLocationManager.locationServiceEnabled()</code> and pop up the <code>alertView</code> ourselves</p>
<h1 id="Start-Standard-Location-Change"><a href="#Start-Standard-Location-Change" class="headerlink" title="Start Standard Location Change"></a>Start Standard Location Change</h1><p>First create a location manager and store it inside the class property. If the location manager is already created, then we can reuse it.</p>
<p>Assign a delegate to update the result when user changes its location.</p>
<p>Setup the <code>desiredAccuracy</code> and <code>distanceFilter</code> to increase or decrease the frequency to fire the location change notification.</p>
<p>After everything all set, call <code>locationManager.startUpdatingLocation()</code> to start monitoring the location change in the background.</p>
<p>Below is the code I use to start a location service:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> locationService <span class="operator">=</span> <span class="type">CLLocationManager</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">enableLocationService</span>()</span> &#123;</span><br><span class="line">  <span class="comment">// check if user disabled location service</span></span><br><span class="line">  <span class="keyword">if</span> <span class="type">CLLocationManager</span>.authorizationStatus() <span class="operator">==</span> <span class="type">CLAuthorizationStatus</span>.denied &#123;</span><br><span class="line">    <span class="comment">// popup alert view let user go to setting and enable it</span></span><br><span class="line">  &#125;</span><br><span class="line">  locationService.requestAlwaysAuthorization()</span><br><span class="line">  locationService.delegate <span class="operator">=</span> <span class="keyword">self</span></span><br><span class="line">  locationService.desiredAccuracy <span class="operator">=</span> kCLLocationAccuracyBestForNavigation</span><br><span class="line">  locationService.distanceFilter <span class="operator">=</span> <span class="number">10</span></span><br><span class="line">  locationService.startUpdatingLocation()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Handle-the-response"><a href="#Handle-the-response" class="headerlink" title="Handle the response"></a>Handle the response</h2><p>Adapt self to <code>CLLocationManagerDelegate</code> and implement the following method. Note that sometimes location manager will cache the old value result, so you should check if this is a recent update. Only accept a result that is not cached by comparing the location service time stamp. See code blow for details.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">locationManager</span>(<span class="keyword">_</span> <span class="params">manager</span>: <span class="type">CLLocationManager</span>, <span class="params">didFailWithError</span> <span class="params">error</span>: <span class="type">Error</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;ERROR: location update error. ERROR: <span class="subst">\(error.localizedDescription)</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">locationManager</span>(<span class="keyword">_</span> <span class="params">manager</span>: <span class="type">CLLocationManager</span>, <span class="params">didUpdateLocations</span> <span class="params">locations</span>: [<span class="type">CLLocation</span>])</span> &#123;</span><br><span class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> lastLocation <span class="operator">=</span> locations.last <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// error and abort in debug build</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> eventDate <span class="operator">=</span> lastLocation.timestamp</span><br><span class="line">  <span class="keyword">let</span> howRecent <span class="operator">=</span> fabs(eventDate.timeIntervalSinceNow)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make sure its a recent item, not a cached one.</span></span><br><span class="line">  <span class="keyword">guard</span> howRecent <span class="operator">&lt;</span> <span class="number">15</span> <span class="keyword">else</span> &#123; <span class="comment">// seconds</span></span><br><span class="line">    <span class="comment">// discard the cached item</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;latitude: <span class="subst">\(lastLocation.coordinate.latitude)</span>, longitude: <span class="subst">\(lastLocation.coordinate.longitude)</span>&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ol>
<li> <a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/UserExperience/Conceptual/LocationAwarenessPG/CoreLocation/CoreLocation.html">apple&#39;s official documentation</a></li>
</ol>
</div></article></div></section><footer><div class="paginator"><a href="/2016/11/04/Pass%20Type%20As%20Parameter/" class="prev">PREV</a><a href="/2016/10/21/Config%20ScrollView%20With%20Autolayout%20in%20Interface%20Builder/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'nuynait';
var disqus_identifier = '2016/11/02/iOS Location Service/';
var disqus_title = 'iOS Location Service';
var disqus_url = 'http://blog.jerryshan.com/2016/11/02/iOS Location Service/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//nuynait.disqus.com/count.js" async></script><!-- block copyright--></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>