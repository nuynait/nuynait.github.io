<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Basic of Core Data Framework · Tianyun Shan</title><meta name="description" content="Basic of Core Data Framework - Tianyun Shan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/img.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.jerryshan.com/atom.xml" title="Tianyun Shan"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/img.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Basic of Core Data Framework</h1><div class="post-info">Nov 8, 2016</div><div class="post-content"><p>This blog talks about the basic of core data. Mainly focused on how to use core data to save your object into the database. It will cover some problem I met when I was using core data. More advanced usage will be covered in future posts.</p>
<span id="more"></span>

<h1 id="Data-Model-File"><a href="#Data-Model-File" class="headerlink" title="Data Model File"></a>Data Model File</h1><p>First before using core data service, we need to have its core, the <code>.xcdatamodeId</code> file inside directory. When you select use core data before creating the project, this file is auto created for you. If not, you need to create that file yourself.</p>
<p><img src="20161130_172718_4289gLV.png"></p>
<p>After you created your data model, click and open it, you can see a plus sign on the bottom. Click to add an entity.</p>
<p>Here is a brief explanation on what these things is. For example, entity attributes, relationships, etc. It is easier for you to understand if you have some database knowledge. It is basically grab the object in your model and translates each property and instance into the database column and tuple.</p>
<h2 id="Entity-Attributes-Relationships"><a href="#Entity-Attributes-Relationships" class="headerlink" title="Entity, Attributes, Relationships"></a>Entity, Attributes, Relationships</h2><p>An entity is a table in database. It is the class object in your code. Consider the following object</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class Student &#123;</span><br><span class="line">  let id: Int64</span><br><span class="line">  let name: String</span><br><span class="line">  let finishedCourse: [Course] &#x2F;&#x2F; course the student finished</span><br><span class="line">  let faculty: Faculty</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Course &#123;</span><br><span class="line">  let id: Int64</span><br><span class="line">  let name: String</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Faculty &#123;</span><br><span class="line">  let name: String</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here, <code>Student</code>, <code>Course</code>, <code>Faculty</code> is the entity.</p>
<p>For <code>Course</code> object, <code>id</code>, <code>name</code> is its attribute.</p>
<p>For relationships, take a look at <code>Student</code> class, it has four properties, the <code>finishedCourse</code> is a <code>Course</code> array, and facility is <code>Faculty</code> object. Yes. if you have a property, its type is an object, then this property does not go into attribute filed. It should be a relationship. If it contains an array of object, it is a <code>One-Many</code> object. Otherwise, it will most likely to be a <code>One~One</code> object.</p>
<h2 id="Inverse-of-relationship"><a href="#Inverse-of-relationship" class="headerlink" title="Inverse of relationship"></a>Inverse of relationship</h2><p>If you set the relationship like what you do in <code>Student</code> class, it is not acceptable in core-data. The reason is for each relationship, we must have its corresponding inverse relationship. So this is what we usually do.</p>
<p>For example, we can see that the above student class has a faculty class, so we create a one to one relationship under entity <code>Student</code> called <code>faculty</code>. Select its destination to <code>Faculty</code> and leave inverse empty for now. Now switch to <code>Faculty</code> entity, go to the relationship, create a new relationship, set its destination back to <code>Student</code>, and select its inverse to the one we previously created <code>faculty</code>. Now go back to student entity, and you can see an inverse relationship has been linked automatically to the one you created in faculty entity<br><img src="20161130_183530_4289tVb.png"></p>
<p><img src="20161130_183608_42896fh.png"></p>
<p><img src="20161130_183659_4289U0t.png"></p>
<p>At last, make sure you select the relationship type in the right hand side panel. In the example, the <code>faulty</code> is To one, the <code>finishedCourse</code> is To many.</p>
<h2 id="Export-in-class-object"><a href="#Export-in-class-object" class="headerlink" title="Export in class object"></a>Export in class object</h2><p>After we setup the Data Model file, it means the data base used to store the model has been setup properly. Now we need to create the object that represent the model in code. Previously, I use some sample codes to made an example, about the relationship on student, course, and faculty. That is just for clarification. In real world, you don’t create these class yourself. If you decide the class is used in core data, then the class itself should be created from core data, because they need to be subclass of <code>NSManagedObject</code></p>
<p>If you don’t export the file manually, it will auto generate files for you but you will miss a lot of customization possibilities.</p>
<p>Here is how we do if we want to manually export those classes. First, select each entity and give it an object name, by default, it is the same to the entity. Under the class - name, you can see <code>Module</code> and <code>Codegen</code>, select <code>Module</code> as <code>Current Product Module</code> and <code>Codegen</code> as <code>Manual/None</code>.</p>
<p>Now select the menu <code>Editor -&gt; Create NSManagedObject Subclass</code>, you can see an export guide, follow the guide and you will have the class definition file.</p>
<p>After that, you should be able to compile your project. If you see an error about redeclaring the object, you need to go back and see the <code>Module</code> and <code>Codegen</code> field of each entity you exported. Because by default, it will automatically generate the code file.</p>
<h1 id="Create-Update-Remove-Instance"><a href="#Create-Update-Remove-Instance" class="headerlink" title="Create, Update, Remove Instance"></a>Create, Update, Remove Instance</h1><p>Now we have the basic structure setup. All we need to know is how to create new instance, update them, save to database.</p>
<h2 id="Init-Data-Base"><a href="#Init-Data-Base" class="headerlink" title="Init Data Base"></a>Init Data Base</h2><p>Before you do anything, the first thing is to init your core data database. If you take a look at the official tutorial, they have detail explanation on how to init the database. Below is the code I am using.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// <span class="doctag">TODO:</span> If terminate during app startup, make this async and if this is async, load database later after it finished</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">initCoreData</span>()</span> &#123;</span><br><span class="line">  <span class="comment">// This resource is the same name as your xcdatamodeld contained in your project.</span></span><br><span class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> modelURL <span class="operator">=</span> <span class="type">Bundle</span>.main.url(forResource: <span class="string">&quot;MNDataModel&quot;</span>, withExtension:<span class="string">&quot;momd&quot;</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">fatalError</span>(<span class="string">&quot;Error loading model from bundle&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// The managed object model for the application. It is a fatal error for the application not to be able to find and load its model.</span></span><br><span class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> mom <span class="operator">=</span> <span class="type">NSManagedObjectModel</span>(contentsOf: modelURL) <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">fatalError</span>(<span class="string">&quot;Error initializing mom from: <span class="subst">\(modelURL)</span>&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> psc <span class="operator">=</span> <span class="type">NSPersistentStoreCoordinator</span>(managedObjectModel: mom)</span><br><span class="line">  managedObjectContext <span class="operator">=</span> <span class="type">NSManagedObjectContext</span>(concurrencyType: .mainQueueConcurrencyType)</span><br><span class="line">  managedObjectContext.persistentStoreCoordinator <span class="operator">=</span> psc</span><br><span class="line">  <span class="comment">//    DispatchQueue.global().async &#123;</span></span><br><span class="line">  <span class="keyword">let</span> urls <span class="operator">=</span> <span class="type">FileManager</span>.default.urls(for: .documentDirectory, in: .userDomainMask)</span><br><span class="line">  <span class="keyword">let</span> docURL <span class="operator">=</span> urls[urls.endIndex<span class="operator">-</span><span class="number">1</span>]</span><br><span class="line">  <span class="comment">/* The directory the application uses to store the Core Data store file.</span></span><br><span class="line"><span class="comment">   This code uses a file named &quot;DataModel.sqlite&quot; in the application&#x27;s documents directory.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">let</span> storeURL <span class="operator">=</span> docURL.appendingPathComponent(<span class="string">&quot;DataModel.sqlite&quot;</span>)</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> psc.addPersistentStore(ofType: <span class="type">NSSQLiteStoreType</span>, configurationName: <span class="literal">nil</span>, at: storeURL, options: <span class="literal">nil</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="built_in">fatalError</span>(<span class="string">&quot;Error migrating store: <span class="subst">\(error)</span>&quot;</span>)</span><br><span class="line">    <span class="comment">//      &#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>NOTE:</strong> When init database, it usually happens in the app launch time. You should run huge tasks because if the app takes too much time on start up, it will be terminated by the OS.</p>
<p>Currently in my above code, I am running everything sync. This should not happen. It should run <code>async</code>. The reason I make it <code>sync</code> is because when app launch, I load everything in database into the memory. So if the setup database is async, then when I load from database, it is possible that the init process has not finished yet. In the future, I may check if init finished, before loading from database.</p>
<h2 id="Basic-Operations"><a href="#Basic-Operations" class="headerlink" title="Basic Operations"></a>Basic Operations</h2><p>Create an entity:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">createItemToDatabase</span>(<span class="params">entityName</span>: <span class="type">String</span>)</span> -&gt; <span class="type">NSManagedObject</span>? &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="type">NSEntityDescription</span>.insertNewObject(forEntityName: entityName, into: managedObjectContext) <span class="keyword">as?</span> <span class="type">NSManagedObject</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Load all the instance into memory:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">loadFromDatabase</span>(<span class="params">entityName</span>: <span class="type">String</span>)</span> -&gt; [<span class="type">MNManagedObject</span>]<span class="operator">?</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> fetchRequest <span class="operator">=</span> <span class="type">NSFetchRequest</span>&lt;<span class="type">NSFetchRequestResult</span>&gt;(entityName: entityName)</span><br><span class="line">  <span class="keyword">var</span> fetchedResult: [<span class="type">MNManagedObject</span>]<span class="operator">?</span></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> result: [<span class="keyword">Any</span>] <span class="operator">=</span> <span class="keyword">try</span> managedObjectContext.fetch(fetchRequest)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> managedObjectResults <span class="operator">=</span> result <span class="keyword">as?</span> [<span class="type">MNManagedObject</span>] &#123;</span><br><span class="line">      fetchedResult <span class="operator">=</span> managedObjectResults</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="type">MNDebugUtils</span>.errorPrintAbort(object: <span class="string">&quot;MNCoreDataController&quot;</span>,</span><br><span class="line">                                   function: <span class="string">&quot;loadFromDisk:entityName&quot;</span>,</span><br><span class="line">                                   errorMsg: <span class="string">&quot;fetched from data base, but cannot cast items to [MNEntityProtocol], Did you adapt to protocol when creating new entities?&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="type">MNDebugUtils</span>.errorPrintAbort(object: <span class="string">&quot;MNCoreDataController&quot;</span>,</span><br><span class="line">                                 function: <span class="string">&quot;loadFromDisk:entityName&quot;</span>,</span><br><span class="line">                                 errorMsg: <span class="string">&quot;Cannot get result from database&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fetchedResult</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Clear the database:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">clearDatabase</span>(<span class="params">entityName</span>: <span class="type">String</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> fetchRequest <span class="operator">=</span> <span class="type">NSFetchRequest</span>&lt;<span class="type">NSFetchRequestResult</span>&gt;(entityName: entityName)</span><br><span class="line">  <span class="keyword">let</span> deleteRequest <span class="operator">=</span> <span class="type">NSBatchDeleteRequest</span>(fetchRequest: fetchRequest)</span><br><span class="line">  <span class="keyword">let</span> psc <span class="operator">=</span> managedObjectContext.persistentStoreCoordinator</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> psc<span class="operator">?</span>.execute(deleteRequest, with: managedObjectContext)</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="type">MNDebugUtils</span>.errorPrintAbort(object: <span class="string">&quot;MNCoreDataController&quot;</span>, function: <span class="string">&quot;clearDatabase:entityName&quot;</span>, errorMsg: <span class="string">&quot;Cannot delete instance from database&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When you update the item, just update the <code>NSManagedObject</code> you get from the database as normal. The change is not saved into database until you call the following.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">managedObjectContext.save()</span><br></pre></td></tr></table></figure>

<h1 id="BUG-Questions-Problems"><a href="#BUG-Questions-Problems" class="headerlink" title="BUG? Questions? Problems?"></a>BUG? Questions? Problems?</h1><p>Below is any additional problems that I have when I use Core Data.</p>
<h2 id="Insert-Failed-casting"><a href="#Insert-Failed-casting" class="headerlink" title="Insert Failed (casting?)"></a>Insert Failed (casting?)</h2><p>If you ever had a problem when you create the instance and casting it from <code>NSManagedObject</code> to custom subclass and it returns <code>nil</code>, then you may want to check the following.</p>
<p>First make sure that you have on select <code>Current Product Module</code> under Class - Module.</p>
<p><img src="20161201_112557_4289TID.png"></p>
<p>if that doesn’t help, make sure you don’t have <code>@Objc(className)</code> before the class definition</p>
<p>Take a look at <a target="_blank" rel="noopener" href="http://stackoverflow.com/a/25076929/2581637">this</a> answer for additional helps</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ol>
<li> <a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/CoreData/index.html#//apple_ref/doc/uid/TP40001075-CH2-SW1">Official Tutorial</a></li>
<li> <a target="_blank" rel="noopener" href="https://code.tutsplus.com/tutorials/core-data-from-scratch-managed-objects-and-fetch-requests--cms-21284">Tutorial From Tuts - Detail Description About Core Data</a></li>
</ol>
</div></article></div></section><footer><div class="paginator"><a href="/2016/12/14/iOS%20Settings%20Bundle/" class="prev">PREV</a><a href="/2016/11/07/Protobuf%20Swift/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'nuynait';
var disqus_identifier = '2016/11/08/Basic of Core Data Framework/';
var disqus_title = 'Basic of Core Data Framework';
var disqus_url = 'http://blog.jerryshan.com/2016/11/08/Basic of Core Data Framework/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//nuynait.disqus.com/count.js" async></script><!-- block copyright--></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>