<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Create C++ Static Library and Use in Swift Â· Tianyun Shan</title><meta name="description" content="Create C++ Static Library and Use in Swift - Tianyun Shan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/img.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.jerryshan.com/atom.xml" title="Tianyun Shan"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/img.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Create C++ Static Library and Use in Swift</h1><div class="post-info">Jan 17, 2017</div><div class="post-content"><p>Here is an overview on what I did. Right now at the very beginning, we have the c++ source code file and the iOS Xcode project file. We need to create a new Xcode project and put in c++ source code and compile it and create <code>.a</code> static library. Then put the new project and my iOS Xcode Project in the same workspace. Import the library path and the header path. At this point, the <code>c++</code> static library is now successfully imported into our existing swift project. The rest we need to do is to call the <code>c++</code> library inside our swift file.</p>
<span id="more"></span>

<h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>Here is an overview on what I did. Right now at the very beginning, we have the c++ source code file and the iOS Xcode project file. We need to create a new Xcode project and put in c++ source code and compile it and create <code>.a</code> static library. Then put the new project and my iOS Xcode Project in the same workspace. Import the library path and the header path. At this point, the <code>c++</code> static library is now successfully imported into our existing swift project. The rest we need to do is to call the <code>c++</code> library inside our swift file.</p>
<p>In order to do this, we need to create an <code>Objective-C++</code> class with extension <code>.h .mm</code>. Inside that class, we can import the header file of our <code>c++</code> static library. <strong>DO NOT</strong> directly import the header file inside the bridge header. The bridge header is <code>Objective-C</code> header. Objective-C can import <code>c</code> files but not <code>c++</code>. Inside the object you created in <code>Objective-C++</code> write all the APIs you want to use. Inside the bridge header file, import that <code>Objective-C++</code> header file. Now the <code>Objective-C++</code> class has exposed to swift. We can now use it inside swift classes.</p>
<h1 id="Create-Library-Project"><a href="#Create-Library-Project" class="headerlink" title="Create Library Project"></a>Create Library Project</h1><p>The first step is to compile c++ source code into <code>.a</code> library. Create a new project in Xcode first. When creating the project, choose <code>Cocoa Touch Static   Library</code>. When choosing the location, go to the workspace for the existing iOS project. At bottom, there is option to <code>Add to:</code>, choose the workspace name and press enter. Open the existing iOS project workspace and you will see the newly created project there.</p>
<h1 id="Import-Source-and-Compile-Library"><a href="#Import-Source-and-Compile-Library" class="headerlink" title="Import Source and Compile Library"></a>Import Source and Compile Library</h1><p>Now we need to import the <code>c++</code> source code into the newly created project and compile <code>.a</code> static library.</p>
<p>Choose the project folder and open in finder, copy all the c++ source code over. In Xcode <code>File -&gt; Add Files to ...</code>, add everything into the project. Build and run. If everything works fine, it will compile success and create the <code>.a</code> library under the project folder in project navigator.</p>
<p>For Mapsted library, we need to set up a little bit more.</p>
<h2 id="Compile-as-C"><a href="#Compile-as-C" class="headerlink" title="Compile as C++"></a>Compile as C++</h2><p>Sometimes, when I compile the code, it gives me error like <code>#include    &lt;string&gt;</code> not found. This may be cause it compiles c++ code as c code. In order to fix that please do the following.</p>
<p><img src="20170118_105526_799BEb.png"></p>
<p>On the left (project navigation panel) choose the library project, go to build settings and search for <code>Compile Sources As</code>. Then choose c++.</p>
<h2 id="Absolute-Include-Path"><a href="#Absolute-Include-Path" class="headerlink" title="Absolute Include Path"></a>Absolute Include Path</h2><p>We use absolute include path inside our c++ library, so we need to setup the compiler flag, otherwise we will have compiler error saying that include file does not exists.</p>
<p>By absolute include path I mean <code>#include &lt;abc/def.h&gt;</code> instead of <code>#include    &quot;def.h&quot;</code>. For details, see <a target="_blank" rel="noopener" href="http://stackoverflow.com/a/12563042/2581637">here</a>.</p>
<p>In order to compile, we need to add <code>-I&lt;path&gt;</code> flag to compiler. Here is how to do it.</p>
<p><img src="20170118_104754_79905U.png"></p>
<p>On the left (project navigation panel) choose the library project, go to build settings and search for other c flags. Then add <code>-I</code> and follow the full path where the source code home directly is. No space in between.</p>
<h2 id="Compiling-Protobuf-Code"><a href="#Compiling-Protobuf-Code" class="headerlink" title="Compiling Protobuf Code"></a>Compiling Protobuf Code</h2><p>First, we use protobuf, but we didn&#39;t use all the protobuf source. When compiling the protobuf source code, we might have files not compilable. They mainly file names contain <code>unitest</code> or <code>test</code> and many other files that import .h files that does not exists. For those files, simply delete in project navigator and choose move to trash.</p>
<h1 id="Import-Library-into-the-existing-iOS-project"><a href="#Import-Library-into-the-existing-iOS-project" class="headerlink" title="Import Library into the existing iOS project"></a>Import Library into the existing iOS project</h1><p>Now if you see the left side (project navigation panel), there is a <code>Products</code> folder and under it you can see the generated <code>.a</code> file. Now right click the library file and open in finder. You can see the location for the <code>.a</code> file is under the Xcode <code>DerivedData</code> path. Copy it out into the library folder itself. You can create a products folder like what I did.</p>
<p><img src="20170118_110233_799bYn.png"></p>
<p>Now, lets go to the existing iOS project and select it in the project navigator (left panel in Xcode).</p>
<p><img src="20170118_110539_7991sz.png"></p>
<p>Drag and drop the library file under build <code>Build Phases -&gt; Link Binary With   Libraries</code></p>
<p><img src="20170118_110837_7990AJ.png"></p>
<p><img src="20170118_110816_799n2C.png"></p>
<p>Config correct header search path and library search path. For header search path, enter the path to the source code folder (Theoretically, only header files are needed. So you can point to a folder that contains all the header file of the library). For library search path, enter the path to the folder that contains the library you compiled.</p>
<p>At this point, the library should be imported successfully, try to compile the run the iOS project and everything should be good.</p>
<p>Now you can import the header file directly inside the project. For example:</p>
<p><img src="20170118_111426_799BLP.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;MapstedPositioningCpp.h&quot;</span><br></pre></td></tr></table></figure>

<h1 id="Create-In-Middle-Objective-C-File"><a href="#Create-In-Middle-Objective-C-File" class="headerlink" title="Create In-Middle Objective-C++ File"></a>Create In-Middle Objective-C++ File</h1><p>In order to use the c++ library in swift, we need to create the in middle <code>Objective-C++</code> class. <strong>Remember</strong> do NOT import the header file directly in bridge header file. Why?</p>
<p>The bridge header file is <code>Objective-C</code>. So it will see the file you import as <code>c</code> files instead of <code>c++</code>.</p>
<p>This is what you can do to create the in middle <code>Objective-C++</code> class. First create a new <code>Objective-C</code> file. Now we have <code>.h .m</code> files in project navigator. Rename <code>.m</code> into <code>.mm</code> so now it becomes a <code>Objective-C++</code> file.</p>
<p><strong>Remember</strong> don&#39;t use any c++ codes in the header file and only include c++ .h files inside implementation file</p>
<p>For Header:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  NSObject+MNMapstedLib.h</span></span><br><span class="line"><span class="comment">//  nav</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by Tianyun Shan on 2017-01-17.</span></span><br><span class="line"><span class="comment">//  Copyright Â© 2017 Maspted. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MNMapstedLib</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testFunction;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>For Implementation:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  NSObject+MNMapstedLib.m</span></span><br><span class="line"><span class="comment">//  nav</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by Tianyun Shan on 2017-01-17.</span></span><br><span class="line"><span class="comment">//  Copyright Â© 2017 Maspted. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;NSObject+MNMapstedLib.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;MapstedPositioningCpp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MNMapstedLib</span></span></span><br><span class="line"></span><br><span class="line">MapstedCpp::MapstedPositioningCpp *myObject;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)init &#123;</span><br><span class="line">  <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="comment">// init variables</span></span><br><span class="line">    myObject = new MapstedCpp::MapstedPositioningCpp();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testFunction</span><br><span class="line">&#123;</span><br><span class="line">  myObject-&gt;TestNetworkCall();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>Above the is class I created to test the library. <strong>NOTE</strong>, you can see above, anything related to <code>c++</code> is written in <code>c++</code> code. This is necessary.</p>
<p>For example, I init the <code>MapstedCpp::MapstedPositioningCpp</code> object using c++ syntax. If I use <code>[[MapstedCpp::MapstedPositioningCpp alloc] init]</code> then I will get the error message such as <code>Bad receiver type...</code> etc.</p>
<h2 id="Summarize"><a href="#Summarize" class="headerlink" title="Summarize"></a>Summarize</h2><p>The header file that import in <code>Swift Objective-C Bridge File</code> cannot contain anything c++. Hide all the c++ objects or codes within the implementation.</p>
<p>This also includes anything that include with in the header file. They should all be pure <code>Objective-C or C</code> objects.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>Here are some references about <code>c++</code> and <code>Objective-C++</code></p>
<p><a target="_blank" rel="noopener" href="http://robnapier.net/wrapping-cppfinal-edition">Wrapping C++ Final Edition</a></p>
<p><a target="_blank" rel="noopener" href="http://philjordan.eu/article/mixing-objective-c-c++-and-objective-c++">Mixing Objective-C, C++ and Objective-C++</a></p>
<h1 id="Use-in-Swift"><a href="#Use-in-Swift" class="headerlink" title="Use in Swift"></a>Use in Swift</h1><p>Now we can bridge the <code>Objective-C++</code> class just like what we do to <code>Objective-C</code> class. Create bridge header file (or use the existing bridge header file). Import the class we wrote.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;NSObject+MNMapstedLib.h&quot;</span><br></pre></td></tr></table></figure>

<p>Now, you can use the <code>Objective-C++</code> class inside Swift.</p>
<h1 id="Bridge-Implementation"><a href="#Bridge-Implementation" class="headerlink" title="Bridge Implementation"></a>Bridge Implementation</h1><p>When I was implementing the bridge using <code>Objective-C / Objective-C++</code> I encountered following problems. Because it is my first time interacting with a c++ library in Swift, I want to find most clear and efficient way for writing the bridge. Below are all the problems I have and how I solve those problems myself. They may not be the best solution out there. Please let me know if I did anything wrong or anything can be improve to be better.</p>
<h2 id="Obtain-Objects-Declared-in-C"><a href="#Obtain-Objects-Declared-in-C" class="headerlink" title="Obtain Objects Declared in C++"></a>Obtain Objects Declared in C++</h2><p>When I need to get data from the library, the problem I have is the representation of the data. In C++ the data is represented in a class and with in that class, it contains other class as properties.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; This is only a pseudo-concept for what I described above</span><br><span class="line">class A &#123;</span><br><span class="line">  B b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class B &#123;</span><br><span class="line">  int bVal;</span><br><span class="line">  C cData;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class C &#123;</span><br><span class="line">  int cVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So let&#39;s assume the above example, when I request for the data from the library, the library will give me something like <code>class A</code>. However that <code>A</code> is a c++ object, it is impossible for me to directly interact with <code>A</code> in swift. That is where the <code>bridge</code> kicks in.</p>
<p>The <code>Objective-C</code> and <code>Objective-C++</code> codes interacts in the middle as a bridge. So what I need to do at this point is to expose the result <code>A</code> to the bridge and then provide another pure <code>Objective-C</code> objects to <code>Swift</code>.</p>
<p>Recall that in <code>Objective-C</code> I have a main bridge class which is the one that I import in the <code>Swift Bridge Header File</code>. It is a singleton class contains all the APIs to interact with different modules of the bridge.</p>
<p>What I do here is to create an object called <code>ABridge.h</code> and <code>ABridge.mm</code>. <code>#import âxx/ABridge.hâ</code> with in the main bridge singleton class. At first, I would like to create a class that contains all the property that c++ has and convert the c++ function properties into objective c properties. However, I found that is a little bit unnecessary.</p>
<p>So what I do is I store a private instance for the c++ class <code>A</code> with in the implantation file. I write all the public getter and setters to get the value I want for <code>A</code></p>
<p>Note here we need to be careful. In the interface <code>.h</code> file, we cannot have import the <code>c++</code> library which means we cannot have any <code>c++</code> class with in the interface. We mentioned about that <em>here.</em></p>
<p>Here is how I do it in code:</p>
<p>.h File</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@interface ABridge : NSObject</span><br><span class="line"></span><br><span class="line">- (id)initWithID: (NSInteger)aID;</span><br><span class="line"></span><br><span class="line">- (NSInteger)getBVal;</span><br><span class="line">- (NSInteger)getCVal;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>.mm File</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;xxxCPPLib&gt;</span><br><span class="line">#import &quot;ABridge.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation ABridge &#123;</span><br><span class="line">  &#x2F;&#x2F; private</span><br><span class="line">  std::shared_ptr&lt;Cpp::A&gt; cppA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (id)initWithID: (NSInteger)aID &#123;</span><br><span class="line">  self &#x3D; [super init];</span><br><span class="line">  if (self) &#123;</span><br><span class="line">    &#x2F;&#x2F; get A pointer from cpp library using ID</span><br><span class="line">    cppA &#x3D; Cpp::AManager::sharedInstance().getAByID(aID);</span><br><span class="line">    if (!cppA) &#123;</span><br><span class="line">      &#x2F;&#x2F; if not get cppA, do not initialize self</span><br><span class="line">      return nil;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSInteger)getBVal &#123;</span><br><span class="line">  return cppA-&gt;getB().getBVal();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSInteger)getCVal &#123;</span><br><span class="line">  return cppA-&gt;getB().getC().getCVal();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><h2 id="Not-Compile"><a href="#Not-Compile" class="headerlink" title="Not Compile"></a>Not Compile</h2><p>If it still not compiles, check the following. When import the library into workspace, is it the groups as yellow folder, or is it blue folder as folder reference? Make sure every folder is yellow. Look at compiler source and see if it includes all your files as it decide if it compiles the whole library or not.</p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/02/03/Change%20Icon%20Color%20Programmatically/" class="prev">PREV</a><a href="/2016/12/14/iOS%20Settings%20Bundle/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'nuynait';
var disqus_identifier = '2017/01/17/Create C++ Static Library and Use in Swift/';
var disqus_title = 'Create C++ Static Library and Use in Swift';
var disqus_url = 'http://blog.jerryshan.com/2017/01/17/Create C++ Static Library and Use in Swift/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//nuynait.disqus.com/count.js" async></script><!-- block copyright--></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>