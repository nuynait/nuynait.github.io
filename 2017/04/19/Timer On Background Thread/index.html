<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Timer On Background Thread · Tianyun Shan</title><meta name="description" content="Timer On Background Thread - Tianyun Shan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/img.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.jerryshan.com/atom.xml" title="Tianyun Shan"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/img.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Timer On Background Thread</h1><div class="post-info">Apr 19, 2017</div><div class="post-content"><p>Sometimes when we schedule a timer we might want to schedule it on a background thread if the timer is updating in a short interval. Here is how I managed to do it.</p>
<span id="more"></span>

<h1 id="NSTimer-and-RunLoop"><a href="#NSTimer-and-RunLoop" class="headerlink" title="NSTimer and RunLoop"></a>NSTimer and RunLoop</h1><p>Usually, when you schedule a timer, you call <code>scheduledTimer:withTimeInterval</code>. When this get called, it actually gets the main thread <code>RunLoop</code> and add into it. However, for background threads, you have to get the <code>RunLoop</code> and add <code>NSTimer</code> onto the <code>RunLoop</code> yourself.</p>
<h2 id="Codes"><a href="#Codes" class="headerlink" title="Codes"></a>Codes</h2><p>Here is the full block of codes</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RunTimer</span></span>&#123;</span><br><span class="line">  <span class="keyword">let</span> queue <span class="operator">=</span> <span class="type">DispatchQueue</span>(label: <span class="string">&quot;Timer&quot;</span>, qos: .background, attributes: .concurrent)</span><br><span class="line">  <span class="keyword">let</span> timer: <span class="type">Timer</span>?</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">startTimer</span>()</span> &#123;</span><br><span class="line">    <span class="comment">// schedule timer on background</span></span><br><span class="line">    queue.async &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> <span class="keyword">_</span> <span class="operator">=</span> <span class="keyword">self</span>.timer &#123;</span><br><span class="line">        <span class="keyword">self</span>.timer<span class="operator">?</span>.invalidate()</span><br><span class="line">        <span class="keyword">self</span>.timer <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> currentRunLoop <span class="operator">=</span> <span class="type">RunLoop</span>.current</span><br><span class="line">      <span class="keyword">self</span>.timer <span class="operator">=</span> <span class="type">Timer</span>(timeInterval: <span class="keyword">self</span>.updateInterval, target: <span class="keyword">self</span>, selector: #selector(<span class="keyword">self</span>.timerTriggered), userInfo: <span class="literal">nil</span>, repeats: <span class="literal">true</span>)</span><br><span class="line">      currentRunLoop.add(<span class="keyword">self</span>.timer<span class="operator">!</span>, forMode: .commonModes)</span><br><span class="line">      currentRunLoop.run()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">timerTriggered</span>()</span> &#123;</span><br><span class="line">    <span class="comment">// it will run under queue by default</span></span><br><span class="line">    debug()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">debug</span>()</span> &#123;</span><br><span class="line">    <span class="comment">// print out the name of current queue</span></span><br><span class="line">    <span class="keyword">let</span> name <span class="operator">=</span> __dispatch_queue_get_label(<span class="literal">nil</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="type">String</span>(cString: name, encoding: .utf8))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">stopTimer</span>()</span> &#123;</span><br><span class="line">    queue.sync &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">      <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">_</span> <span class="operator">=</span> <span class="keyword">self</span>.timer <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// error, timer already stopped</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">self</span>.timer<span class="operator">?</span>.invalidate()</span><br><span class="line">      <span class="keyword">self</span>.timer <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Create-Queue"><a href="#Create-Queue" class="headerlink" title="Create Queue"></a>Create Queue</h2><p>First, create a queue to make timer run on background and store that queue as a class property in order to reuse it for stop timer. I am not sure if we need to use the same queue for start and stop, the reason I did this is because I saw a warning message <a target="_blank" rel="noopener" href="https://developer.apple.com/reference/foundation/runloop">here</a>.</p>
<blockquote>
<p>The RunLoop class is generally not considered to be thread-safe and its methods should only be called within the context of the current thread. You should never try to call the methods of an RunLoop object running in a different thread, as doing so might cause unexpected results.  </p>
</blockquote>
<p>So I decided to store the queue and use the same queue for the timer to avoid synchronization issues.</p>
<p>Also create an empty timer and stored in the class variable as well. Make it optional so you can stop the timer and set it to <code>nil</code>.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RunTimer</span></span>&#123;</span><br><span class="line">  <span class="keyword">let</span> queue <span class="operator">=</span> <span class="type">DispatchQueue</span>(label: <span class="string">&quot;Timer&quot;</span>, qos: .background, attributes: .concurrent)</span><br><span class="line">  <span class="keyword">let</span> timer: <span class="type">Timer</span>?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Start-Timer"><a href="#Start-Timer" class="headerlink" title="Start Timer"></a>Start Timer</h2><p>To start timer, first call <code>async</code> from <code>DispatchQueue</code>. Then it is a good practice to first check if the timer has already started. If the <code>timer</code> variable is not <code>nil</code>, then <code>invalidate()</code> it and set it to <code>nil</code>.</p>
<p>The next step is to get the current <code>RunLoop</code>. Because we did this in the block of <code>queue</code> we created, it will get the <code>RunLoop</code> for the background queue we created before.</p>
<p>Create the timer. Here instead of using <code>scheduledTimer</code>, we just call the constructor of timer and pass in whatever property you want for the timer such as <code>timeInterval</code>, <code>target</code>, <code>selector</code>, etc.</p>
<p>Add the created timer to the <code>RunLoop</code>. Run it.</p>
<p>Here is a question about running the <code>RunLoop</code>. According to the documentation <a target="_blank" rel="noopener" href="https://developer.apple.com/reference/foundation/nsrunloop/1412430-run?language=objc">here</a>, it says it effectively begins an infinite loop that processes data from the run loop&#39;s input sources and timers.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">startTimer</span>()</span> &#123;</span><br><span class="line">  <span class="comment">// schedule timer on background</span></span><br><span class="line">  queue.async &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="keyword">_</span> <span class="operator">=</span> <span class="keyword">self</span>.timer &#123;</span><br><span class="line">      <span class="keyword">self</span>.timer<span class="operator">?</span>.invalidate()</span><br><span class="line">      <span class="keyword">self</span>.timer <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> currentRunLoop <span class="operator">=</span> <span class="type">RunLoop</span>.current</span><br><span class="line">    <span class="keyword">self</span>.timer <span class="operator">=</span> <span class="type">Timer</span>(timeInterval: <span class="keyword">self</span>.updateInterval, target: <span class="keyword">self</span>, selector: #selector(<span class="keyword">self</span>.timerTriggered), userInfo: <span class="literal">nil</span>, repeats: <span class="literal">true</span>)</span><br><span class="line">    currentRunLoop.add(<span class="keyword">self</span>.timer<span class="operator">!</span>, forMode: .commonModes)</span><br><span class="line">    currentRunLoop.run()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Trigger-Timer"><a href="#Trigger-Timer" class="headerlink" title="Trigger Timer"></a>Trigger Timer</h2><p>Implement the function as normal. When that function gets called, it is called under the queue by default.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">timerTriggered</span>()</span> &#123;</span><br><span class="line">  <span class="comment">// under queue by default</span></span><br><span class="line">  debug()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">debug</span>()</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> name <span class="operator">=</span> __dispatch_queue_get_label(<span class="literal">nil</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="type">String</span>(cString: name, encoding: .utf8))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>debug</code> function above is use to print out the name of the queue. If you ever worry if it has been running on the <code>queue</code>, you can call it to check.</p>
<h2 id="Stop-Timer"><a href="#Stop-Timer" class="headerlink" title="Stop Timer"></a>Stop Timer</h2><p>Stop timer is easy, call <code>validate()</code> and set the timer variable stored inside class to nil.</p>
<p>Here I am running it under the <code>queue</code> again. Because of the warning <a target="_blank" rel="noopener" href="https://developer.apple.com/reference/foundation/runloop">here</a> I decided to run all the timer related code under the queue to avoid conflicts.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">stopTimer</span>()</span> &#123;</span><br><span class="line">  queue.sync &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">_</span> <span class="operator">=</span> <span class="keyword">self</span>.timer <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// error, timer already stopped</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.timer<span class="operator">?</span>.invalidate()</span><br><span class="line">    <span class="keyword">self</span>.timer <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Some-Additional-Questions"><a href="#Some-Additional-Questions" class="headerlink" title="Some Additional Questions"></a>Some Additional Questions</h1><p>I am not fully understand this concepts. Here is some questions I have.</p>
<h2 id="Stop-RunLoop"><a href="#Stop-RunLoop" class="headerlink" title="Stop RunLoop"></a>Stop RunLoop</h2><p>I am somehow a little bit confused on if we need to manually stop the <code>RunLoop</code> or not. According to the documentation <a target="_blank" rel="noopener" href="https://developer.apple.com/reference/foundation/runloop/1412430-run">here</a>, it seems that when no timers attached to it, then it will exits immediately. So when we stop the timer, it should exists itself. However, at the end of that document, it also said that removing all known input sources and timers from the run loop is not a guarantee that the run loop will exit. macOS can install and remove additional input sources as needed to process requests targeted at the receiver’s thread. Those sources could therefore prevent the run loop from exiting.</p>
<p>I tried the solution below which provide in the documentation for guarantee to terminate the loop. However the timer does not fired after I change <code>.run()</code> to the code below.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="keyword">self</span>.timer <span class="operator">!=</span> <span class="literal">nil</span> <span class="operator">&amp;&amp;</span> currentRunLoop.run(mode: .commonModes, before: <span class="type">Date</span>.distantFuture)) &#123;&#125;;</span><br></pre></td></tr></table></figure>

<p>What I am thinking is that it might be safe for just using <code>.run()</code> on iOS. Because the documentation states that macOS is install and remove additional input sources as needed to process requests targeted at the receiver’s thread. So iOS might be fine.</p>
<h2 id="RunLoop-modes"><a href="#RunLoop-modes" class="headerlink" title="RunLoop modes"></a>RunLoop modes</h2><p>When add timer onto <code>RunLoop</code>, we need to pass a variable for the mode. <code>Table 3-1</code> <a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html">here</a> list all the modes available and their definition but I didn&#39;t understand them all.</p>
<p>My understanding right now is if it is a timer, it will use <code>.commonModes</code>.</p>
<p>I may update this part whenever I got time to look deep into this.</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>Here are some useful links about running timer on background threads</p>
<ul>
<li>  <a target="_blank" rel="noopener" href="http://stackoverflow.com/a/24017878/2581637">should NSTimer always added into runloop to execute - stackoverflow</a></li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2017/04/21/Protected%20Property%20In%20Objective-C/" class="prev">PREV</a><a href="/2017/04/08/File%20Management%20in%20Swift/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'nuynait';
var disqus_identifier = '2017/04/19/Timer On Background Thread/';
var disqus_title = 'Timer On Background Thread';
var disqus_url = 'http://blog.jerryshan.com/2017/04/19/Timer On Background Thread/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//nuynait.disqus.com/count.js" async></script><!-- block copyright--></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>