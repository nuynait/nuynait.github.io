<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Lag When Setting Image To UIImageView · Tianyun Shan</title><meta name="description" content="Lag When Setting Image To UIImageView - Tianyun Shan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.jerryshan.com/atom.xml" title="Tianyun Shan"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Lag When Setting Image To UIImageView</h1><div class="post-info">Mar 2, 2018</div><div class="post-content"><p>I haven’t touch the code for Mapsted Navigation for iOS a long time, and after I refactor the code I open the app, I notice that there is a significant lag when scroll in building list. End up it caused by assign image to an <code>UIImageView</code>.</p>
<span id="more"></span>

<h2 id="How-I-Narrow-Down-The-Issue"><a href="#How-I-Narrow-Down-The-Issue" class="headerlink" title="How I Narrow Down The Issue"></a>How I Narrow Down The Issue</h2><p> I start to look down on where it gets lag. I found out that the lag happens in this function.  This function is inside a cell, so it is called every time a cell is drawing.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">redrawImageMask</span>(<span class="params">image</span>: <span class="type">UIImage</span>)</span> &#123;</span><br><span class="line">  <span class="type">DispatchQueue</span>.global(qos: .background).async &#123;</span><br><span class="line">    <span class="keyword">let</span> maskedImage <span class="operator">=</span> image.maskImage(width: <span class="type">MNBuildingListTableViewController</span>.<span class="type">CELL_ROW_WIDTH</span><span class="operator">*</span><span class="number">2</span>, height: <span class="type">MNBuildingListTableViewController</span>.<span class="type">CELL_SELECTED_ROW_HEIGHT</span><span class="operator">*</span><span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">      <span class="keyword">self</span>.imageMask.image <span class="operator">=</span> maskedImage</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>First I thought its the masking that cause the issue, but for masking image, I am doing it in the background,  which should not cause the lag. Then I commented the mask and I found out that it is still lag, so the problem happen at the time when assign image to the <code>UIImageView</code>.</p>
<blockquote>
<p>A little note here: previously, the lag happens every time when a cell gets reuse. After I commented the mask, the lag only happens when it first uses the cell. I guess this is because lag happens on assign the image, the reason for it only lag the first time is because it is not changing the image (masking the image) every time cell gets redraw so when assign the image with the same image, it does not lag anymore.  </p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">  <span class="keyword">self</span>.imageMask.image <span class="operator">=</span> maskedImage</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="My-Solution"><a href="#My-Solution" class="headerlink" title="My Solution"></a>My Solution</h2><p>Here is how I solve this issue. I wrote a function helper inside <code>UIImage</code> extension. In <code>Swift</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIImage</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Use this function to decompress the image.</span></span><br><span class="line"><span class="comment">   * Please run this function in a background thread to avoid occupy main thread.</span></span><br><span class="line"><span class="comment">   * The reason for this function is to avoid lag when assign to image view</span></span><br><span class="line"><span class="comment">   * https://stackoverflow.com/a/10818917/2581637</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">decompress</span>()</span> -&gt; <span class="type">UIImage</span>? &#123;</span><br><span class="line">    <span class="type">UIGraphicsBeginImageContextWithOptions</span>(size, <span class="literal">false</span>, scale)</span><br><span class="line">    draw(at: .zero)</span><br><span class="line">    <span class="keyword">let</span> new: <span class="type">UIImage</span>? <span class="operator">=</span> <span class="type">UIGraphicsGetImageFromCurrentImageContext</span>()</span><br><span class="line">    <span class="type">UIGraphicsEndImageContext</span>()</span><br><span class="line">    <span class="keyword">return</span> new</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// To use this function</span></span><br><span class="line"><span class="type">DispatchQueue</span>.global(qos: .background).async &#123;</span><br><span class="line">  <span class="keyword">let</span> newImage <span class="operator">=</span> image.decompressed()</span><br><span class="line">  <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">    <span class="keyword">self</span>.imageMask.image <span class="operator">=</span> newImage</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="Solution-From-Stackoverflow"><a href="#Solution-From-Stackoverflow" class="headerlink" title="Solution From Stackoverflow"></a>Solution From Stackoverflow</h2><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/a/10818917/2581637">Here</a> is a very useful link that provide helpful answers. Below is the mirror version of the answer in case link gets removed. Credit to  <a target="_blank" rel="noopener" href="https://stackoverflow.com/users/815742/fumoboy007">@fumoboy007</a>.</p>
<p>EDIT 2: Here is a Swift version that contains a few improvements. (Untested.)<br><a target="_blank" rel="noopener" href="https://gist.github.com/fumoboy007/d869e66ad0466a9c246d">https://gist.github.com/fumoboy007/d869e66ad0466a9c246d</a></p>
<hr>
<p>EDIT: Actually, I believe all that is necessary is the following. (Untested.)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- (void)loadImageNamed:(NSString *)name &#123;</span><br><span class="line">	dispatch_async(self.dispatchQueue, ^&#123;</span><br><span class="line">		&#x2F;&#x2F; Determine path to image depending on scale of device&#39;s screen,</span><br><span class="line">		&#x2F;&#x2F; fallback to 1x if 2x is not available</span><br><span class="line">		NSString *pathTo1xImage &#x3D; [[NSBundle mainBundle] pathForResource:name ofType:@&quot;png&quot;];</span><br><span class="line">		NSString *pathTo2xImage &#x3D; [[NSBundle mainBundle] pathForResource:[name stringByAppendingString:@&quot;@2x&quot;] ofType:@&quot;png&quot;];</span><br><span class="line"></span><br><span class="line">		NSString *pathToImage &#x3D; ([UIScreen mainScreen].scale &#x3D;&#x3D; 1 || !pathTo2xImage) ? pathTo1xImage : pathTo2xImage;</span><br><span class="line"></span><br><span class="line">		UIImage *image &#x3D; [[UIImage alloc] initWithContentsOfFile:pathToImage];    </span><br><span class="line">        &#x2F;&#x2F; Decompress image</span><br><span class="line">      if (image) &#123;</span><br><span class="line">          UIGraphicsBeginImageContextWithOptions(image.size, NO, image.scale);    </span><br><span class="line">          [image drawAtPoint:CGPointZero];</span><br><span class="line">          image &#x3D; UIGraphicsGetImageFromCurrentImageContext();</span><br><span class="line">          UIGraphicsEndImageContext();</span><br><span class="line">      &#125;</span><br><span class="line">		&#x2F;&#x2F; Configure the UI with pre-decompressed UIImage</span><br><span class="line">    	dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    		self.image &#x3D; image;</span><br><span class="line">    	&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>ORIGINAL ANSWER: It turns out that it wasn’t <code>self.image = image;</code> directly. The UIImage image loading methods don’t decompress and process the image data right away; they do it when the view refreshes its display. So the solution was to go a level lower to Core Graphics and decompress and process the image data myself. The new code looks like the following.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">- (void)loadImageNamed:(NSString *)name &#123;</span><br><span class="line">	dispatch_async(self.dispatchQueue, ^&#123;</span><br><span class="line">		&#x2F;&#x2F; Determine path to image depending on scale of device&#39;s screen,</span><br><span class="line">		&#x2F;&#x2F; fallback to 1x if 2x is not available</span><br><span class="line">		NSString *pathTo1xImage &#x3D; [[NSBundle mainBundle] pathForResource:name ofType:@&quot;png&quot;];</span><br><span class="line"> 		NSString *pathTo2xImage &#x3D; [[NSBundle mainBundle] pathForResource:[name stringByAppendingString:@&quot;@2x&quot;] ofType:@&quot;png&quot;];</span><br><span class="line"> 		NSString *pathToImage &#x3D; ([UIScreen mainScreen].scale &#x3D;&#x3D; 1 || !pathTo2xImage) ? pathTo1xImage : pathTo2xImage;</span><br><span class="line"></span><br><span class="line"> 		UIImage *uiImage &#x3D; nil;</span><br><span class="line"></span><br><span class="line"> 		if (pathToImage) &#123;</span><br><span class="line"> 			&#x2F;&#x2F; Load the image</span><br><span class="line"> 			CGDataProviderRef imageDataProvider &#x3D; CGDataProviderCreateWithFilename([pathToImage fileSystemRepresentation]);</span><br><span class="line"> 			CGImageRef image &#x3D; CGImageCreateWithPNGDataProvider(imageDataProvider, NULL, NO, kCGRenderingIntentDefault);</span><br><span class="line"></span><br><span class="line"> 			&#x2F;&#x2F; Create a bitmap context from the image&#39;s specifications</span><br><span class="line"> 			&#x2F;&#x2F; (Note: We need to specify kCGImageAlphaPremultipliedFirst | kCGBitmapByteOrder32Little</span><br><span class="line"> 			&#x2F;&#x2F; because PNGs are optimized by Xcode this way.)</span><br><span class="line"> 			CGColorSpaceRef colorSpace &#x3D; CGColorSpaceCreateDeviceRGB();</span><br><span class="line"> 			CGContextRef bitmapContext &#x3D; CGBitmapContextCreate(</span><br><span class="line">						NULL,</span><br><span class="line">						CGImageGetWidth(image),</span><br><span class="line">						CGImageGetHeight(image),</span><br><span class="line">						CGImageGetBitsPerComponent(image),</span><br><span class="line">						CGImageGetWidth(image) * 4,</span><br><span class="line">						colorSpace,</span><br><span class="line">						kCGImageAlphaPremultipliedFirst | kCGBitmapByteOrder32Little);</span><br><span class="line"></span><br><span class="line"> 			&#x2F;&#x2F; Draw the image into the bitmap context</span><br><span class="line"> 			CGContextDrawImage(bitmapContext, CGRectMake(0, 0, CGImageGetWidth(image), CGImageGetHeight(image)), image);</span><br><span class="line"></span><br><span class="line">          &#x2F;&#x2F;  Extract the decompressed image</span><br><span class="line"> 			CGImageRef decompressedImage &#x3D; CGBitmapContextCreateImage(bitmapContext);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  			&#x2F;&#x2F; Create a UIImage</span><br><span class="line">  			uiImage &#x3D; [[UIImage alloc] initWithCGImage:decompressedImage];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  			&#x2F;&#x2F; Release everything</span><br><span class="line">  			CGImageRelease(decompressedImage);</span><br><span class="line">  			CGContextRelease(bitmapContext);</span><br><span class="line"> 			CGColorSpaceRelease(colorSpace);</span><br><span class="line">  			CGImageRelease(image);</span><br><span class="line">  			CGDataProviderRelease(imageDataProvider);</span><br><span class="line">  		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  		&#x2F;&#x2F; Configure the UI with pre-decompressed UIImage</span><br><span class="line">  		dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">  			self.image &#x3D; uiImage;</span><br><span class="line">  		&#125;);</span><br><span class="line">  	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2018/03/07/iTunes%20Connect%20Encryption%20Information/" class="prev">PREV</a><a href="/2018/02/17/Responsive%20Header%20Over%20Image/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2021 <a href="http://blog.jerryshan.com">Tianyun Shan</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>