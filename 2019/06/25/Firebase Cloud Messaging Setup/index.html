<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Firebase Cloud Messaging Setup ¬∑ Tianyun Shan</title><meta name="description" content="Firebase Cloud Messaging Setup - Tianyun Shan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.jerryshan.com/atom.xml" title="Tianyun Shan"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Firebase Cloud Messaging Setup</h1><div class="post-info">Jun 25, 2019</div><div class="post-content"><p>Everything about setting up Android project with Firebase Cloud Messaging.</p>
<span id="more"></span>

<h1 id="Adding-Firebase"><a href="#Adding-Firebase" class="headerlink" title="Adding Firebase"></a>Adding Firebase</h1><p>If your project have not used firebase before, follow <a target="_blank" rel="noopener" href="https://firebase.google.com/docs/android/setup">Add Firebase to your Android project ¬†|¬† Firebase</a> official documentation to add the firebase SDK.</p>
<p>In your project-root <em>build.gradle</em>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Top-level build file where you can add configuration options common to all sub-projects&#x2F;modules.</span><br><span class="line"></span><br><span class="line">buildscript &#123;</span><br><span class="line">    ext.kotlin_version &#x3D; &#39;1.3.21&#39;</span><br><span class="line">    repositories &#123;</span><br><span class="line">		  &#x2F;&#x2F;...</span><br><span class="line">        google()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">		  &#x2F;&#x2F;...</span><br><span class="line">        classpath &#39;com.google.gms:google-services:4.2.0&#39;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">		  &#x2F;&#x2F;...</span><br><span class="line">        google()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Trouble Shooting</strong><br>If you see error message of merge <em>android support library</em> with <em>androidx</em> failed, upgrade your android project with <em>androidx</em> using  <a target="_blank" rel="noopener" href="https://developer.android.com/jetpack/androidx/migrate">Migrating to AndroidX</a></p>
<h2 id="Multiple-Google-Services-Json"><a href="#Multiple-Google-Services-Json" class="headerlink" title="Multiple Google Services Json"></a>Multiple Google Services Json</h2><p>If you have multiple build variant / flavour, you probably want to use different <code>google-services.json</code> depends on different build variant. The answer is yes, you can. <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/42086133/2581637">Here</a> is a stack-overflow answer that might help.</p>
<p>For detail, do something like following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">|-- Project</span><br><span class="line">	|-- app</span><br><span class="line">		|-- src</span><br><span class="line">			|-- production</span><br><span class="line">				|-- google-services.json</span><br><span class="line">			|-- staging</span><br><span class="line">				|-- google-services.json</span><br><span class="line">			|-- debug</span><br><span class="line">				|-- google-services.json</span><br></pre></td></tr></table></figure>

<h1 id="Import-Firebase-Messaging-Framework"><a href="#Import-Firebase-Messaging-Framework" class="headerlink" title="Import Firebase Messaging Framework"></a>Import Firebase Messaging Framework</h1><p>In your app-level <em>build.gradle</em> file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &#39;com.android.application&#39;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line"> &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply plugin: &#39;com.google.gms.google-services&#39;</span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation &#39;com.google.firebase:firebase-core:17.0.0&#39;</span><br><span class="line">    implementation &#39;com.google.firebase:firebase-messaging:19.0.0&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After import the object, create a firebase messaging service by create an object in your codebase that extends <em>FirebaseMessagingService</em>. Here is an example in <a target="_blank" rel="noopener" href="https://github.com/firebase/quickstart-android/blob/9d2c53324e6797eae93b2536110b80f3eed27850/messaging/app/src/main/java/com/google/firebase/quickstart/fcm/java/MyFirebaseMessagingService.java">Java</a> or <a target="_blank" rel="noopener" href="https://github.com/firebase/quickstart-android/blob/master/messaging/app/src/main/java/com/google/firebase/quickstart/fcm/kotlin/MyFirebaseMessagingService.kt">Kotlin</a></p>
<p>Here is an example I created in Kotlin:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> services</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> com.google.firebase.messaging.FirebaseMessagingService</span><br><span class="line"><span class="keyword">import</span> com.google.firebase.messaging.RemoteMessage</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LowesFirebaseMessagingService</span>: <span class="type">FirebaseMessagingService</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;LowesFirebaseMessaging&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * here are two types of messages data messages and notification messages. Data messages are handled</span></span><br><span class="line"><span class="comment">     * here in onMessageReceived whether the app is in the foreground or background. Data messages are the type</span></span><br><span class="line"><span class="comment">     * traditionally used with GCM. Notification messages are only received here in onMessageReceived when the app</span></span><br><span class="line"><span class="comment">     * is in the foreground. When the app is in the background an automatically generated notification is displayed.</span></span><br><span class="line"><span class="comment">     * When the user taps on the notification they are returned to the app. Messages containing both notification</span></span><br><span class="line"><span class="comment">     * and data payloads are treated as notification messages.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p0: The remote push notification message received.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMessageReceived</span><span class="params">(p0: <span class="type">RemoteMessage</span>?)</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;From: <span class="subst">$&#123;p0?.from&#125;</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Called if InstanceID token is updated. This may occur if the security of</span></span><br><span class="line"><span class="comment">     * the previous token had been compromised. Note that this is called when the InstanceID token</span></span><br><span class="line"><span class="comment">     * is initially generated so this is where you would retrieve the token.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p0: The new token in string.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onNewToken</span><span class="params">(p0: <span class="type">String</span>?)</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;Refreshed token: <span class="variable">$p0</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Send the new token to our backend server.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After created the above class, head to the <em>AndroidManifest.xml</em>, add the following service in between the <em><application></em> tag:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;application</span><br><span class="line">    android:name&#x3D;&quot;presentation.application.myApplication&quot;</span><br><span class="line">    ....&gt;</span><br><span class="line">	  ...</span><br><span class="line">    &lt;service</span><br><span class="line">      android:name&#x3D;&quot;services.LowesFirebaseMessagingService&quot;</span><br><span class="line">      android:exported&#x3D;&quot;false&quot;&gt;</span><br><span class="line">      &lt;intent-filter&gt;</span><br><span class="line">          &lt;action android:name&#x3D;&quot;com.google.firebase.MESSAGING_EVENT&quot; &#x2F;&gt;</span><br><span class="line">      &lt;&#x2F;intent-filter&gt;</span><br><span class="line">    &lt;&#x2F;service&gt;</span><br><span class="line">	  ...</span><br><span class="line">&lt;&#x2F;application</span><br></pre></td></tr></table></figure>

<p>The <em>android:name</em> is the package path for the object created above.</p>
<h2 id="Get-device-token"><a href="#Get-device-token" class="headerlink" title="Get device token"></a>Get device token</h2><p>Write the following code into your app to get the device token: (For <em>Java</em>/<em>Kotlin</em>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">FirebaseInstanceId.getInstance().getInstanceId()</span><br><span class="line">    .addOnCompleteListener(<span class="keyword">new</span> OnCompleteListener&lt;InstanceIdResult&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">(<span class="meta">@NonNull</span> Task&lt;InstanceIdResult&gt; task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!task.isSuccessful()) &#123;</span><br><span class="line">          Log.w(TAG, <span class="string">&quot;getInstanceId failed&quot;</span>, task.getException());</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get new Instance ID token</span></span><br><span class="line">        String token = task.getResult().getToken();</span><br><span class="line">        Log.d(TAG, token);</span><br><span class="line"></span><br><span class="line">		  <span class="comment">// <span class="doctag">TODO:</span> Send device token to our server</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FirebaseInstanceId.getInstance().instanceId</span><br><span class="line">    .addOnCompleteListener(OnCompleteListener &#123; task -&gt;</span><br><span class="line">      <span class="keyword">if</span> (!task.isSuccessful) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">&quot;getInstanceId failed&quot;</span>, task.exception)</span><br><span class="line">        <span class="keyword">return</span><span class="symbol">@OnCompleteListener</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Get new Instance ID token</span></span><br><span class="line">      <span class="keyword">val</span> token = task.result?.token</span><br><span class="line">      Log.d(TAG, token)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> Send device token to our server</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p><strong>Note:</strong> The token can get renewed or refreshed under certain conditions. Implement the callback <code>onNewToken</code> in the object extends <em>FirebaseMessagingService</em> to get noticed.</p>
<hr>
<p>üß™ Now you can try to <strong>send a notification to your testing device</strong> using the device token. The notification banner (Heads up notification) may not appear. However, you can still break or print from the method <em>onMessageReceived</em> to see the payload data or notification title.</p>
<hr>
<h1 id="Create-Notification"><a href="#Create-Notification" class="headerlink" title="Create Notification"></a>Create Notification</h1><p>So now if you send a notification to your testing device, it will vibrate and nothing more will happen. This is because in the <em>onMessageReceived</em> callback, currently you only log the notification received. You didn‚Äôt create the notification. Here is how to create a  <a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/ui/notifiers/notifications?hl=en#Heads-up">Heads-Up Notification</a></p>
<p>(If you are sending a notification only type message you will be able to see the notification at this stage. See below for detail.)</p>
<p>Before create any heads-up notification, here is what you need to know. There are two type of notification in FCM (<em>Firebase Cloud Messaging</em>)</p>
<ol>
<li>Notification messages.</li>
<li>Data messages.</li>
</ol>
<p>See <a target="_blank" rel="noopener" href="https://firebase.google.com/docs/cloud-messaging/concept-options#notifications_and_data_messages">About FCM messages ¬†|¬† Firebase</a> for detail.</p>
<h2 id="Notification-Messages-vs-Data-Messages"><a href="#Notification-Messages-vs-Data-Messages" class="headerlink" title="Notification Messages vs. Data Messages."></a>Notification Messages vs. Data Messages.</h2><p>[If you want to know how to send different type of push notification via http-protocol (<em>Restful Api</em>), see the other notes: <em>Firebase Cloud Messaging Send Message Via HTTP Protocol</em>.]</p>
<p>For <strong>Notification Messages</strong>, android display the heads-up notification depends on the <em>JSON</em> you send. (title, subtitle, icon, etc.). Will simply launch app when click on the message. If you want specific behaviour after click on message, you can choose <strong>Data Messages</strong> or <strong>Notification With Data Payloads</strong></p>
<p>For <strong>Data Messages</strong>, app will call <em>OnMessageReceived</em> to handle the message as soon as it gets received. The method will be fired even if the app not opened. You will need to create heads-up message yourself under function <em>OnMessageReceived</em></p>
<p>You can also build a push notification with both <em>Notification Messages</em> and <em>Data Messages</em>. I call it <strong>Notification With Data Payloads</strong>. In this case, android first display the heads-up notification depends on <em>JSON</em> in the notification section: (title, subtitle, icon) etc. If you have specify the <em>‚Äùclick_action‚Äù</em> in the notification section, it will launch the activity you specified there and put all the data payloads into the activity intent extras.</p>
<p>I would suggest to use <strong>Data Messages</strong> directly for more flexible. With <strong>Data Message</strong> you will be able to change layout, or even use custom layout. There‚Äôs no disadvantage because the <em>OnMessageReceived</em> gets called even when app gets killed.</p>
<h2 id="Notification-Icons"><a href="#Notification-Icons" class="headerlink" title="Notification Icons"></a>Notification Icons</h2><p>There are two kinds of icons displayed in the <em>Notification Center</em>. A <strong>small icon</strong> and a <strong>large icon</strong>.</p>
<p>The <strong>large icon</strong> only used when you create the heads-up notification manually with <em>Data messages</em>.</p>
<p>The setup process for icon is different depends on different type of messages.  I found an image below from <a target="_blank" rel="noopener" href="https://documentation.onesignal.com/docs/customize-notification-icons">this site</a> , it shows how small icon and large icon displayed.<br><img src="Screen%20Shot%202019-06-26%20at%201.49.57%20PM.png"></p>
<p>After my investigation of all different notification styles, there are two different style. The first one is the showing the status above and title / description below, the second one is showing an icon on the left and title / description on the right. For Api level &gt; API_23, they use second style. For Api level &lt;= API_23, they use the first style.</p>
<hr>
<p>I tested on Android 6 (Nexus 5), there is a problem. It will use a large icon with a small icon combo, and if there is a problem which I setup the icon properly but <strong>it shows a white cube</strong>. Why is that happening?</p>
<p>Because on old device the notification icon should be entirely white. (The outlines has to be white with transparent background). Try <a target="_blank" rel="noopener" href="https://romannurik.github.io/AndroidAssetStudio/icons-notification.html#source.type=clipart&source.clipart=ac_unit&source.space.trim=1&source.space.pad=0&name=ic_stat_ac_unit">Android Asset Studio</a> to generate a notification icon properly.</p>
<p>‚ö†Ô∏è Make sure your notification icon is 24dp * 24dp and is pure white with transparency. Here is an example sketch file for the notification icon I design.</p>
<p><a href='lowes-notification-icon.sketch'>lowes-notification-icon.sketch</a></p>
<hr>
<p>For <em>small icon</em>, if you use type <em>Notification Messages</em> or <em>Notification With Data Payloads</em>, you can specify what icon to use by passing <em>icon</em> property under <em>notification</em> section. The <em>icon</em> property is a String for drawable name. The <em>icon</em> property is optional. Add following code to your <em>AndroidManifest.xml</em> to avoid icon property.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta-data android:name&#x3D;&quot;com.google.firebase.messaging.default_notification_icon&quot;</span><br><span class="line">android:resource&#x3D;&quot;@drawable&#x2F;ic_notification_launcher_original&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;meta-data</span><br><span class="line">android:name&#x3D;&quot;com.google.firebase.messaging.default_notification_color&quot;</span><br><span class="line">android:resource&#x3D;&quot;@color&#x2F;color_accent&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>
<p>(Add between application tags)</p>
<h2 id="Create-Notification-Manually"><a href="#Create-Notification-Manually" class="headerlink" title="Create Notification Manually"></a>Create Notification Manually</h2><p>So if you send a pure data message, the callback <em>onMessageReceived</em> will gets fired no matter what state app is in. It by default will not create any heads-up notification. Unless you implemented in that callback. Here is an example implementation.</p>
<p>Assume the following code locates in class <em>LowesFirebaseMessagingService : FirebaseMessagingService()</em></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;LowesFirebaseMessaging&quot;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> CHANNEL_ID = <span class="string">&quot;Lowes_Notification_Channel&quot;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> CHANNEL_DESCRIPTION = <span class="string">&quot;Lowes Notification&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Data Keys</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> NOTIFICATION_DATA_KEY_TITLE = <span class="string">&quot;title&quot;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> NOTIFICATION_DATA_KEY_BODY = <span class="string">&quot;body&quot;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> NOTIFICATION_DATA_KEY_DEEP_LINK = <span class="string">&quot;deep-link&quot;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> NOTIFICATION_DATA_KEY_WEB_LINK = <span class="string">&quot;http-link&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMessageReceived</span><span class="params">(p0: <span class="type">RemoteMessage</span>?)</span></span> &#123;</span><br><span class="line">    p0?.let &#123; sendNotification(it) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">sendNotification</span><span class="params">(p0: <span class="type">RemoteMessage</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> defaultSoundUri = RingtoneManager.getDefaultUri(RingtoneManager.TYPE_NOTIFICATION)</span><br><span class="line">    <span class="keyword">val</span> notificationManager = getSystemService(Context.NOTIFICATION_SERVICE) <span class="keyword">as</span> NotificationManager</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Since android Oreo notification channel is needed.</span></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">        <span class="keyword">val</span> channel = NotificationChannel(CHANNEL_ID,</span><br><span class="line">                CHANNEL_DESCRIPTION,</span><br><span class="line">                NotificationManager.IMPORTANCE_HIGH)</span><br><span class="line">        notificationManager.createNotificationChannel(channel)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> intent = Intent(<span class="keyword">this</span>, LaunchActivity::<span class="keyword">class</span>.java)</span><br><span class="line">    intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP)</span><br><span class="line">    intent.putExtra(NOTIFICATION_DATA_KEY_DEEP_LINK, p0.<span class="keyword">data</span>[NOTIFICATION_DATA_KEY_DEEP_LINK])</span><br><span class="line">    intent.putExtra(NOTIFICATION_DATA_KEY_WEB_LINK, p0.<span class="keyword">data</span>[NOTIFICATION_DATA_KEY_WEB_LINK])</span><br><span class="line">    <span class="keyword">val</span> pendingIntent = PendingIntent.getActivity(<span class="keyword">this</span>, <span class="number">0</span> <span class="comment">/* Request code */</span>, intent,</span><br><span class="line">            PendingIntent.FLAG_ONE_SHOT)</span><br><span class="line">    <span class="keyword">val</span> notificationBuilder = NotificationCompat.Builder(<span class="keyword">this</span>, CHANNEL_ID).run &#123;</span><br><span class="line">        setSmallIcon(R.drawable.ic_notification_small_logo)</span><br><span class="line">        setLargeIcon(BitmapFactory.decodeResource(applicationContext.resources, R.mipmap.ic_launcher))</span><br><span class="line">		  priority = NotificationCompat.PRIORITY_MAX</span><br><span class="line">        setContentTitle(p0.<span class="keyword">data</span>[NOTIFICATION_DATA_KEY_TITLE])</span><br><span class="line">        setContentText(p0.<span class="keyword">data</span>[NOTIFICATION_DATA_KEY_BODY])</span><br><span class="line">        setAutoCancel(<span class="literal">true</span>)</span><br><span class="line">        setSound(defaultSoundUri)</span><br><span class="line">        setContentIntent(pendingIntent)</span><br><span class="line">    &#125;</span><br><span class="line">    notificationManager.notify(<span class="number">0</span>, notificationBuilder.build())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The intent for the <em>LaunchActivity</em> can pass in all kinds of data payloads as you need.</p>
<h2 id="Show-Floating-Window-Banner"><a href="#Show-Floating-Window-Banner" class="headerlink" title="Show Floating Window (Banner)"></a>Show Floating Window (Banner)</h2><p>üß™ You probably noticed, when sending a message, it creates a message in notification centre. However, there‚Äôs not notification banner showing on top.  </p>
<p>If you want android to show a floating window (top floating banner) when received a notification, you will need to set the priority to high/max.</p>
<p>Remember that you have two places to setup. One is to setup the priority attribute for <em>NotificationBuilder</em> when build the notification. The other is the notification level for notification channel. I set to <em>NotificationManager.IMPORTANCE_HIGH</em> in constructor. Notification channel only used in system after <em>Build.VERSION_CODES.O</em></p>
<p>‚ö†Ô∏è It is not recommend to use the priority contains in the <em>RemoteMessage</em>. First of all, the priority is 1 for high, 2 for normal. However, <em>IMPORTANCE_HIGH</em> is 4 and <em>PRIORITY_MAX</em> is 2. Also I don‚Äôt know why if you change the priority level for channel, you will need to reinstall the app for it to work. So I never make it work for dynamic priority.</p>
<p><strong>Trouble shooting:</strong><br>If you see the floating window in lower android version, but not higher android version, check if you have set priority high in notification channel. You will need to <strong>uninstall &amp; reinstall</strong> the app to take affect.</p>
<h2 id="Notification-Click-Events"><a href="#Notification-Click-Events" class="headerlink" title="Notification Click Events"></a>Notification Click Events</h2><p>The other important part is how to handle notification when user click on it. For different type of notification, there are different ways to do it. Let‚Äôs discuss this one by one.</p>
<p>For type: <strong>Notification Messages</strong>, you cannot do anything other than redirect to a specific activity.</p>
<p>To redirect to a specific activity, you will need to add following to the activity you want to redirect.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity</span><br><span class="line">    android:name&#x3D;&quot;presentation.activities.LaunchActivity&quot;</span><br><span class="line">    android:theme&#x3D;&quot;@style&#x2F;LauncherTheme&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- For push notification, launch LaunchActivity after click on the notification. --&gt;</span><br><span class="line">    &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name&#x3D;&quot;example.notification.launch.activity&quot; &#x2F;&gt;</span><br><span class="line">        &lt;category android:name&#x3D;&quot;android.intent.category.DEFAULT&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;intent-filter&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;activity&gt;</span><br></pre></td></tr></table></figure>

<p>The action name <code>example.notification.launch.activity</code> in above example can be customize to any String you want and will be used in the <em>‚Äùclick_action</em> property when composing the notification <em>JSON</em>. See detail in another notes related to <em>send firebase cloud messaging via HTTP.</em></p>
<p>If the app is in foreground, <code>onMessageReceived</code> is getting called and will handle notification manually. See detail in <em>Data Messages</em>.</p>
<p>For type: <strong>Notification With Data Payloads</strong>, you can redirect to any activity using the method states above, as well as passing the data payloads into the activity intent. You can get the payload data hash map by accessing <code>getIntents().getExtras()</code></p>
<p>For type: <strong>Data Messages</strong>, you can specify which activity to launch while creating the heads-up notification. You can also input any data payloads into the intent extras.</p>
<p>So in order to handle everything properly after launching the activity, you can check the intent extras and do anything depends on different intents received.</p>
<p>My suggestion is you can implement the deep-linking for the app and re-use the deep-linking for push notification. For example, you want a notification to go to register screen, then you can implement a deep link to go to the register screen and reuse the logic there.</p>
<h1 id="Custom-Notification"><a href="#Custom-Notification" class="headerlink" title="Custom Notification"></a>Custom Notification</h1><p>First only a data message accepts custom views, if you want custom layout, use a data type message.</p>
<p>If you don‚Äôt like the current notification style, you can also create a custom notification view. You can use <em>ImageView</em> in custom notification view so that you don‚Äôt need to show only the white/transparent icon.</p>
<p>Assume that you don‚Äôt like the large and small icon style for system under api-23, you want to use a square app icon instead:</p>
<p>From:<br><img src="Screen%20Shot%202019-06-28%20at%2010.19.01%20AM.png"><br>To:<br><img src="Screen%20Shot%202019-06-28%20at%2010.17.24%20AM.png"></p>
<p>You will need to first create a <em>layout.xml</em>. Here is an example for the above layout:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;ImageView</span><br><span class="line">        android:id=&quot;@+id/notification_icon&quot;</span><br><span class="line">        android:layout_width=&quot;40dp&quot;</span><br><span class="line">        android:layout_height=&quot;40dp&quot;</span><br><span class="line">        android:layout_alignParentStart=&quot;true&quot;</span><br><span class="line">        android:layout_centerVertical=&quot;true&quot;</span><br><span class="line">        android:layout_marginStart=&quot;11dp&quot;</span><br><span class="line">        android:layout_marginEnd=&quot;11dp&quot;</span><br><span class="line">        android:contentDescription=&quot;@string/app_notification_icon&quot;</span><br><span class="line">        android:src=&quot;@mipmap/ic_launcher&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;LinearLayout</span><br><span class="line">        android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        android:layout_alignParentStart=&quot;true&quot;</span><br><span class="line">        android:layout_centerVertical=&quot;true&quot;</span><br><span class="line">        android:layout_marginStart=&quot;64dp&quot;</span><br><span class="line">        android:orientation=&quot;vertical&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;TextView</span><br><span class="line">            android:id=&quot;@+id/notification_title&quot;</span><br><span class="line">            style=&quot;@style/TextAppearance.Compat.Notification.Title&quot;</span><br><span class="line">            android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">            android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">            android:layout_marginBottom=&quot;3dp&quot;</span><br><span class="line">            android:lines=&quot;1&quot; /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;TextView</span><br><span class="line">            android:id=&quot;@+id/notification_body&quot;</span><br><span class="line">            style=&quot;@style/TextAppearance.Compat.Notification.Info&quot;</span><br><span class="line">            android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">            android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">            android:lines=&quot;1&quot; /&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>[File name: <code>view_headsup_notification_api_23.xml</code>]</p>
<p>Now after created the above xml, when build the notification in <em>NotificationBuilder</em>, specify the <em>setContentIntent</em> to a <em>Remote View</em>. See below code for details.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">val</span> notificationBuilder = NotificationCompat.Builder(<span class="keyword">this</span>, CHANNEL_ID).run &#123;</span><br><span class="line">       setDefaults(NotificationCompat.DEFAULT_ALL)</span><br><span class="line">       setSmallIcon(R.drawable.ic_notification_small_logo)</span><br><span class="line"><span class="comment">// Only show customize view for build under api-23</span></span><br><span class="line">       <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">           <span class="keyword">val</span> remoteView = RemoteViews(packageName, <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.M) R.layout.view_headsup_notification <span class="keyword">else</span> R.layout.view_headsup_notification_api_23)</span><br><span class="line">           remoteView.setTextViewText(R.id.notification_title, p0.<span class="keyword">data</span>[NOTIFICATION_DATA_KEY_TITLE])</span><br><span class="line">           remoteView.setTextViewText(R.id.notification_body, p0.<span class="keyword">data</span>[NOTIFICATION_DATA_KEY_BODY])</span><br><span class="line">           setCustomContentView(remoteView)</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       priority = NotificationCompat.PRIORITY_MAX</span><br><span class="line">       setContentTitle(p0.<span class="keyword">data</span>[NOTIFICATION_DATA_KEY_TITLE])</span><br><span class="line">       setContentText(p0.<span class="keyword">data</span>[NOTIFICATION_DATA_KEY_BODY])</span><br><span class="line"> <span class="comment">// Setup custom view</span></span><br><span class="line">       setContentIntent(pendingIntent)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2019/06/25/Firebase%20Cloud%20Messaging%20Send%20Message%20Via%20HTTP%20Protocol/" class="prev">PREV</a><a href="/2019/06/25/Kotlin%20Lambda%20Deep%20Look./" class="next">NEXT</a></div><div class="copyright"><p>¬© 2015 - 2021 <a href="http://blog.jerryshan.com">Tianyun Shan</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>