<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Setup Apple Push Notification ¬∑ Tianyun Shan</title><meta name="description" content="Setup Apple Push Notification - Tianyun Shan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/img.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.jerryshan.com/atom.xml" title="Tianyun Shan"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/img.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Setup Apple Push Notification</h1><div class="post-info">Jun 28, 2019</div><div class="post-content"><p>Basic about setting up push notification (2019)</p>
<span id="more"></span>

<h1 id="Enable-Push-Notification"><a href="#Enable-Push-Notification" class="headerlink" title="Enable Push Notification"></a>Enable Push Notification</h1><p>The first step is to enable push notification under <em>Target -&gt; Capabilities</em>.  See screenshot below.</p>
<p><img src="Screen%20Shot%202019-06-28%20at%2012.56.53%20PM.png"></p>
<p>Then you will need to create an authentication key file for push notification under your developer team account. Note that you will need an account with admin privilege to do this. Note that this has been changed a little bit compare to the old time. It has become much simpler.</p>
<p><img src="Screen%20Shot%202019-06-28%20at%201.02.36%20PM.png"></p>
<p><em>Create a key:</em><br><img src="Screen%20Shot%202019-06-28%20at%201.03.03%20PM.png"></p>
<h1 id="Remote-Notification-Registration"><a href="#Remote-Notification-Registration" class="headerlink" title="Remote Notification Registration"></a>Remote Notification Registration</h1><p>So you have finished all the preparation, now its time to implement the APN in your project. The first thing you will need to do is to ask for notification permission. Then you will need to register device for the remote notification after user gives the permission. Waiting for callback to extract the device token.</p>
<p>For all these, here is a sample code written in <code>AppDelegate.swift</code>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">registerForPushNotifications</span>()</span> &#123;</span><br><span class="line">    <span class="type">UNUserNotificationCenter</span>.current()</span><br><span class="line">        .requestAuthorization(options: [.alert, .sound, .badge]) &#123;</span><br><span class="line">            [<span class="keyword">weak</span> <span class="keyword">self</span>] granted, error <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;TEST_PUSH: Permission granted: <span class="subst">\(granted)</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">guard</span> granted <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">            <span class="keyword">self</span><span class="operator">?</span>.getNotificationSettings()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getNotificationSettings</span>()</span> &#123;</span><br><span class="line">    <span class="type">UNUserNotificationCenter</span>.current().getNotificationSettings &#123; settings <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;TEST_PUSH: Notification settings: <span class="subst">\(settings)</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">guard</span> settings.authorizationStatus <span class="operator">==</span> .authorized <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">            <span class="type">UIApplication</span>.shared.registerForRemoteNotifications()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span>(<span class="keyword">_</span> <span class="params">application</span>: <span class="type">UIApplication</span>, <span class="params">didRegisterForRemoteNotificationsWithDeviceToken</span> <span class="params">deviceToken</span>: <span class="type">Data</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> tokenParts <span class="operator">=</span> deviceToken.map &#123; data <span class="keyword">in</span> <span class="type">String</span>(format: <span class="string">&quot;%02.2hhx&quot;</span>, data) &#125;</span><br><span class="line">    <span class="keyword">let</span> token <span class="operator">=</span> tokenParts.joined()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;TEST_PUSH: Device Token: <span class="subst">\(token)</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span>(<span class="keyword">_</span> <span class="params">application</span>: <span class="type">UIApplication</span>, <span class="params">didFailToRegisterForRemoteNotificationsWithError</span> <span class="params">error</span>: <span class="type">Error</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;TEST_PUSH: Failed to register push notification: <span class="subst">\(error)</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span>(<span class="keyword">_</span> <span class="params">application</span>: <span class="type">UIApplication</span>, <span class="params">didFinishLaunchingWithOptions</span> <span class="params">launchOptions</span>: [<span class="type">UIApplication</span>.<span class="params">LaunchOptionsKey</span>: <span class="keyword">Any</span>]<span class="operator">?</span>)</span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    registerForPushNotifications()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For the above code:</p>
<ol>
<li>Call <em>registerForPushNotification</em> in <em>didFinishLaunchingWithOptions</em></li>
<li>Call <em>getNotificationSettings</em> to get current notification setting and if its <em>.authorized</em>, <em>registerForRemoteNotification</em></li>
<li>Get device token in <em>didRegisterForRemoteNotificationWithDeviceToken</em> and upload to your own server if needed. (Upload to my server is not include in above sample code)</li>
<li></li>
</ol>
<hr>
<p>üß™ At this stage, you will be able to send a APN to your testing device using the device token and able to see the push notification popup.</p>
<hr>
<h1 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h1><p>Now you can test to see if your implementation works.</p>
<h2 id="Testing-Utility-Tool"><a href="#Testing-Utility-Tool" class="headerlink" title="Testing Utility Tool"></a>Testing Utility Tool</h2><p><a target="_blank" rel="noopener" href="https://github.com/onmyway133/PushNotifications">GitHub - onmyway133/PushNotifications: üêâ A macOS, Linux, Windows app to test push notifications on iOS and Android</a></p>
<p>This is a very useful tool to test your push notification to make sure it works.</p>
<p>For sending an APN, you will need following information:</p>
<ol>
<li>Team ID</li>
<li>Key ID</li>
<li>Key File (created above)</li>
<li>Device Token</li>
</ol>
<p>You can get the team id by login to your development account and select <strong>Membership</strong> on the left panel. You can get the key id when you create the key file.</p>
<h2 id="Send-APN-Via-HTTP-Protocol-Restful-Api"><a href="#Send-APN-Via-HTTP-Protocol-Restful-Api" class="headerlink" title="Send APN Via HTTP Protocol (Restful Api)"></a>Send APN Via HTTP Protocol (Restful Api)</h2><p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/sending_notification_requests_to_apns">Sending Notification Requests to APNs | Apple Developer Documentation</a></p>
<p>See above official documentation to construct a notification post request. Note that you will need to encrypt your key file into <em>Authentication</em> header value. See below for detail for encryption.</p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/establishing_a_token-based_connection_to_apns">Establishing a Token-Based Connection to APNs | Apple Developer Documentation</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2019/07/09/Fish%20Terminal%20Fuzzy%20Finding%20%E2%80%9Cfzf%E2%80%9D/" class="prev">PREV</a><a href="/2019/06/28/iOS%20Multiple%20Firebase%20Apps%20For%20One%20Project/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'nuynait';
var disqus_identifier = '2019/06/28/Setup APN Notification/';
var disqus_title = 'Setup Apple Push Notification';
var disqus_url = 'http://blog.jerryshan.com/2019/06/28/Setup APN Notification/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//nuynait.disqus.com/count.js" async></script><!-- block copyright--></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>